---
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(ggplot2)
require(ggExtra)

```

# Guidance on the Use of Control Charts for Quality Improvement and Monitoring

Every process has natural variation--*noise*--included as an inherent part of that process. True signals emerge only when you have properly characterized that variation.  

Control charts are meant to help you identify departures from a **stable** process. Run charts help you monitor any sort of time series data.  

In many cases, a run chart may be all you need.   

In all cases, *never* rely on a table to evaluate process performance. Tables can supplement graphs, but should never be used without them.   


| Use a run chart if | Use a control chart if |
| ------------------------------------ | ------------------------------------- |
| You are monitoring a process that contains trends or seasonality | You are monitoring a stable statistical process (there is no trend or autocorrelation in the time series, or you have made the appropriate corrections to account for trends or seasonality) |
| You have no expectations that normal day-to-day operations will affect the trend | You expect that normal day-to-day operations will or are meant to keep the process steady |
| You do not need to account for the inherent natural variation in the system | You need to understand and account for the inherent natural variation ("noise") in the system | 
| You have at least 3 data points | You have about 20 or more data points that are in a stable statistical process, or you have performed a power analysis that provides the appropriate n for the appropriate time interval | 
| You want to monitor the behavior of individual or groups of data points to a reference, target, or goal level | You want to monitor the "average" of the system's behavior (i.e., the underlying statistical process)â€”deviations from expectations | 
| You may or may not investigate or act when a data point crosses a reference, target, or goal level | You intend to investigate or act when the process moves outside of control | 
| You have little control over or cannot control the metric (e.g., ED volume/acuity) | You have the potential to control the process driving the metric (e.g., ED wait times) | 
| | You understand the practical trade-offs between the sensitivity and specificity of the control limits relative to your need to investigate or act |
| | You know which statistical distribution to use to calculate the control limits to ensure you have the proper mean-variance relationship |
| You do not understand one or more of the statistical issues discussed in the control chart column | |


### Run charts

Run charts are meant to show variation and trends over time (or in sequence). They do not rely on parametric statistical theory, so they cannot distinguish between common cause and special cause variation. However, improperly-constructed control charts can't either, so run charts can be more readily used where statistical knowledge is limited. So while run charts are not as always as powerful as control charts, they can still provide practical monitoring and useful insights into the process.  

Run charts typically employ the median for the reference line.   

Any metric can be tracked with a run chart.  

**Identifying possible signals of change in run charts**  

- *"Astronomical" data point:* a point so different from the rest that anyone would agree that the value is unusual.  
- *Process shift:* Six or more consecutive points all above or all below the median line.  
- *Trend:* Five or more consecutive points all increasing or all decreasing.  
- *Number of runs:* A run is a set of data points on one side of the median line. Too many or too few runs suggest a pattern inconsistent with natural variation. See Appendix 1 for a table of what constitutes too many/few runs for a given number of data points.    


### Natural variation and control charts

Understanding natural variation in time series data is the essential point of quality assurance or process improvement effort. It's a rookie mistake to use control charts to focus solely on the values themselves or their central tendency.  

Statistical theory provides the basis by which we can evaluate processes to more confidently detect changes in process amongst the noise of natural variation.  



```{r ggmarg}
set.seed(3)
df = data.frame(x = seq(1:36), y = rnorm(36, 19, 2))
# fix(df)
nat_var_plot = ggplot(df, aes(x, y)) + geom_line()
ggMarginal(nat_var_plot, margins="y", type = "histogram", binwidth=1)
```


### Tips and Tricks

- Carefully define your numerator and denominator. Evaluate each separately over time to see whether there are any unusual features or patterns. Sometimes patterns can occur in one or the other than disappear or are ibscured when coalesced into a rate or proportion.  

- The definition of your control limits depends on the trade-off between sensitivity and specificity for the question at hand. Typical control charts are built on 3&sigma; limits, which provides the optimal trade-off between sensitivity and specificity. When you need to err on the side of caution--for example, in patient safety applications--2&sigma; limits may be more appropriate. If you need to err on the side of certainty, 4-6&sigma; limits may be more useful.  
- With fewer than 20 observations, there is an increased chance of missing special cause variation. With more than 30 observations, there's an increased chance of detecting special cause variation that is really just chance. Knowing these outcomes are possible is useful to help facilitiate careful thinking when control charts indicate special cause variation.     

- Ensure your control limits make sense. For example, if you have proportion data and your control limits fall above 100 or below 0, there's clearly an error somewhere. Ditto with negative counts.  

- For continuous data, the definition of the control limits will depend on your question and the data at hand.    

- For count data, prefer u-charts to c-charts. In most cases, we do not have a constant denominator, so c-charts would not be appropriate. Even when we do, using a u-chart helps reduce audience confusion because you are explicitly stating the "per *x*".    

- For proportion data, prefer p-charts to np-charts. Again, we almost never have a constant denominator, so np-charts would not be appropriate. Even when we do, using a p-chart helps reduce audience confusion by explicitly stating the "per *x*".   

- For raw ordinal data (such as likert scores), do not use means or control limits. Just. Don't. If you must plot a single value, convert to a proportion (e.g., "top box scores") first. However, stacked bar or mosaic charts describe this kind of data much better, and can be done in the same amount of space.    

- Control charts don't measure "statistical significance"--they are meant to reduce the chances of incorrectly deciding whether a process is in control or not. Control limits are *not* confidence limits.     

- YTD comparisons don't work because they encourage naive, point-to-point comparisons and ignore natural variation--and can encourage inappropriate knee-jerk reactions. There is never useful information about a process in only one or two data points.  

- CUSUM charts are very good for detecting changes in mean, but are not useful for detecting out of control signals.  


### Which control chart? 


![](https://github.com/Rmadillo/SCH_R_Training/blob/master/images/controlchartflowchart.png)


### 

**Identifying possible signals of special cause variation in control charts**  

- *One or more points fall outside the control limit:* if the data are distributed according to the given control chart's assumptions, the probability of seeing a point outside the control limits when the process has not changed is very low.   
- *Process shift:* Eight or more consecutive points all above or all below the mean line.  
- *Trend:* Seven or more consecutive points all increasing or all decreasing.  
- *Number of runs:* A run is a set of data points on one side of the mean line. Too many or too few runs suggest a pattern inconsistent with natural variation. See Appendix 1 for a table of what constitutes too many/few runs for a given number of data points.    


### Count, proportion, or rate data

The majority of healthcare metrics of concern are rates, so the most common control chart is the u-chart.  

| If your data involve... | use a ... | based on the ... distribution. | 
| ----------------------------- | --------- | ----------------------------- | 
| Rates (with unequal opportunity/variable denominator) | u chart | Poisson | 
| Counts (with equal opportunity/constant denominator) | c chart | Poisson |
| Proportions (with unequal opportunity/variable denominator) | p chart | binomial |
| Proportions (with equal opportunity/constant denominator) | np chart | binomial | 
| Rare events/Infrequent counts (with equal opportunity/constant denominator) | g chart | geometric | 

In each case, the center line will be the arithmetic mean of the data window of interest. Rather than using $\bar{x}$ abbreviation, these values are usually named for each type of chart to help emphasize the use of control limits that are *not* based on the normal distribution.    

Control limits (3&sigma;) are calculated as follows:  

**Rates (u):** $3\sqrt{\frac{u}{n_i}}$   

**Counts (c):** $3\sqrt{c}$  

**Proportions (p):** $3\sqrt{\frac {p (1 - p)}{n_i}}$  

**Infrequent counts (g):** $3\sqrt{g (g + 1)}$  


### Continuous data 







### Testing assumptions

```{r assumpt}
# Autocorrelation
acf(df$y)

# Linear trend (not flat)
summary(lm(y ~ x, data = df))
```

### Examples

``` {r plotfunc, echo = FALSE}
spc.plot <- function(subgroup, point, mean, sigma, k = 3,
                     ucl.show = TRUE, lcl.show = TRUE, ucl.max = Inf, lcl.min = -Inf,
                     label.x = "Subgroup", label.y = "Value")
{
    # Plots control chart with ggplot
    # 
    # Args:
    #   subgroup: Subgroup definition (for x-axis)
    #   point: Subgroup sample values (for y-axis)
    #   mean: Process mean value (for center line)
    #   sigma: Process variation value (for control limits)
    #   k: Specification for k-sigma limits above and below center line.
    #      Default is 3.
    #   ucl.show: Visible upper control limit? Default is true.
    #   lcl.show: Visible lower control limit? Default is true.
    #   ucl.max: Maximum feasible value for upper control limit.
    #   lcl.min: Minimum feasible value for lower control limit.
    #   label.x: Specify x-axis label
    #   label.y: Specify y-axis label.

    df <- data.frame(subgroup, point)
    df$ucl <- min(ucl.max, mean + k*sigma)
    df$lcl <- max(lcl.min, mean - k*sigma)
    
    p <- ggplot(data = df, aes(x = subgroup)) +
        geom_hline(yintercept = mean, col = "gray", size = 1) +
        geom_line(aes(y = point), col = "blue") +
        geom_point(aes(y = point), col = "blue") +
        labs(x = label.x, y =label.y)
    
    if (ucl.show) {
        p <- p + geom_line(aes(y = ucl), col = "red")
    }
    
    if (lcl.show) {
        p <- p + geom_line(aes(y = lcl), col = "red")
    }
    
    p
}

set.seed(100)

```

#### *u* chart example

``` {r uex, fig.height = 3.5}
## Generate sample data
linedays <- sample(1000:2000,36)
infections <- rpois(36, 4)
dates <- seq(as.Date("2013/10/1"), by = "month", length.out = 36)

## Calculate control chart inputs
subgroup.u <- dates
point.u <- infections / linedays * 1000
mean.u <- sum(infections) / sum(linedays) * 1000
sigma.u <- sqrt(mean.u / linedays * 1000)

## Plot control chart
spc.plot(subgroup.u, point.u, mean.u, sigma.u, k = 3, lcl.min  = 0,
         label.x = "Month", label.y = "Infections per 1000 line days")




```

#### *p* chart example

``` {r pex, fig.height = 3.5}
# Generate sample data
discharges <- sample(300:500, 36)
readmits <- rbinom(36, discharges, .2)
dates <- seq(as.Date("2013/10/1"), by = "month", length.out = 36)

# Calculate control chart inputs
subgroup.p <- dates
point.p <- readmits / discharges
mean.p <- sum(readmits) / sum(discharges)
sigma.p <- sqrt(mean.p*(1 - mean.p) / discharges)

# Plot control chart
spc.plot(subgroup.p, point.p, mean.p, sigma.p,
         label.x = "Month", label.y = "Proportion readmitted")


```

#### *g* chart example

``` {r gex, fig.height = 3.5}
# Generate sample data
dates <- sort(as.Date('2013/01/01') + sort(sample(1:1000, 30)))

# Calculate control chart inputs
subgroup.g <- seq(1, length(dates) - 1)
point.g <- as.double(dates[-1] - head(dates, -1))
mean.g <- mean(point.g)
sigma.g <- rep(sqrt(mean.g*(mean.g+1)), length(point.g))

# Plot control chart
spc.plot(subgroup.g, point.g, mean.g, sigma.g, lcl.show = FALSE, k = 3,
         label.x = "Infection number", label.y = "Days between infections")

```

### When assumptions fail


Use a run chart, and do not rely on the runs or process shift rules. 

Still need limits? Use a GAM or GAMM.




### When to revise limits

