---
title: Differences in <br> Inferences <br>
subtitle: <br> Brain surgery and statistical philosophy (using R)
author: "Dwight Barry, PhD  &bull;  Seattle Children's Enterprise Analytics"
date: "May 25, 2016"
output: ioslides_presentation
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


## The study: 

Cognitive outcome after focal surgical resection was retrospectively reviewed for 15 cognitively intact children operated on between 2 and 6 years of age for lesion-related, early-onset epilepsy. Wechsler intelligence tests were conducted prior to and after surgery to explore differences in intelligence between short versus long duration of seizures prior to surgical resection.  

<span style="font-size:75%">The paper: Shurtleff et al 2015. Impact of epilepsy surgery on development of preschool children: identification of a cohort likely to benefit from early intervention. *Journal of Neurosurgery: Pediatrics* 16(4): 383-392. http://dx.doi.org/10.3171/2015.3.PEDS14359</span>

<span style="font-size:70%">This slide deck: https://github.com/Rmadillo/SCH_R_Training/tree/master/Diff_Inf
</span>


## The practical question:

<div class="centered"><span style="font-weight:bold; font-style:italic; font-size: 175%; color:red">Does time from Dx to Tx matter?</span></div>

<br>  

Literature is mixed, partially due to heterogeneous subjects.   

This study focused on a more homogenous group than seen in other lit.   

A drawback to study group similarity was sample size: *n*=15 over a 15 year period.   


## The practical answer:

<div class="centered"><span style="font-weight:bold; font-style:italic; font-size: 175%; color:red">Does time from Dx to Tx matter?</span></div>

<br>  

Probably.

"...shorter seizure duration prior to resection can result in improved cognitive outcome, suggesting that surgery for this population should occur sooner to help improve intelligence outcomes."


## Why we concluded this:

<div class="centered"><span style="font-weight:bold; font-style:italic; font-size: 175%; color:red">Does time from Dx to Tx matter?</span></div> 

<br>  

"Patients who had surgery within 6 months of onset generally had better outcomes compared with patients who had longer duration from the onset of seizures prior to resection. 

While we did not detect statistically significant differences ... clinically important improvements for the short duration group occurred in both FSIQ and nonverbal scores; FSIQ and nonverbal scores improved by 13 and 14 points on average, respectively."


## What would *you* do?

<div class="centered">
![](https://www.poyi.org/65/photos/01/03.jpg)
</div>


## 

<div class="centered">
![](https://pbs.twimg.com/profile_images/557640083709251584/LmA6xXxv.png)
</div>


## R Packages (Ab)Used

```{r LoadLibraries, echo=TRUE}

require(reshape2)   # manipulate data frames
require(htmlTable)  # txtRound function
require(knitr)      # formatted tables
require(psych)      # summary statistics
require(boot)       # bootstrapping
require(coin)       # permutation tests
require(orddom)     # effect sizes
require(BEST)       # Bayesian analysis
require(AICcmodavg) # IT analysis
require(ggplot2)    # graphing

```


```{r ImportData}

# Import main data
DataLong = read.csv("https://raw.githubusercontent.com/Rmadillo/SCH_R_Training/master/Diff_Inf/Shurtleffetal2015_episurg_data.csv", header=T)

# Cast main data to wide format and calculate change in score from Pre to Post
DataWideFSIQ = dcast(DataLong, ID + Side + Duration ~ Phase, value.var = "FSIQ")
DataWideFSIQ$FSIQD = DataWideFSIQ$Post - DataWideFSIQ$Pre

# Remove the Pre and Post columns from each
DataWideFSIQ = DataWideFSIQ[,c(1:3,6)]

# Remove NAs for final Differences results, order to show Short effect
DataWideD = na.omit(DataWideFSIQ)
DataWideD = DataWideD[order(DataWideD$Duration),]

```


```{r sumstats}

# Remove NAs and subset into Short and Long Duration Groups
ShortFSIQD = na.omit(subset(DataWideD$FSIQD, DataWideD$Duration=="Short"))
LongFSIQD = na.omit(subset(DataWideD$FSIQD, DataWideD$Duration=="Long"))

#Set hex colors based on guidelines in* ***Epilepsia*** *and relevel to use pre first
# #A30134 for red/long, #0076C0 for blue/short
epicolors = c("#A30134", "#0076C0")
# relevel Phase so Pre comes first
DataLong$Phase = relevel(DataLong$Phase, ref = "Pre")

# subset and model for mean lines
Sphase = subset(DataLong, DataLong$Duration=="Short")
Lphase = subset(DataLong, DataLong$Duration=="Long")
FSlm = lm(Sphase$FSIQ ~ Sphase$Phase)
FLlm = lm(Lphase$FSIQ ~ Lphase$Phase)

```


## Summary Stats: Change in FSIQ

**Long (>= 18 months Dx to Tx)**  
```{r LongSummary}

sum_stat_table = describeBy(DataWideD$FSIQD, DataWideD$Duration, skew=FALSE)
kable(sum_stat_table[1])

```

**Short (<= 6 months Dx to Tx)**  
```{r ShortSummary}

kable(sum_stat_table[2])

```


## Bottom Line Effect Sizes

**Absolute Mean Differences for Short vs. Long Groups**  

`r txtRound(abs(mean(ShortFSIQD) - mean(LongFSIQD)), 0)`  

**Percent with Same or Improved Score After Surgery**  

*Short*: `r txtRound(length(subset(ShortFSIQD, ShortFSIQD >=0)) / length(ShortFSIQD), 2)`  
*Long*: `r txtRound(length(subset(LongFSIQD, LongFSIQD >=0)) / length(LongFSIQD), 2)`  


## {.flexbox .vcenter}

<div class="centered"><span style="font-weight:bold; font-style:italic; font-size: 200%; color:red">A mean alone means nothing.</span></div> 


## 
```{r densityfig, fig.height=5.5}
m1dur = subset(DataWideD$FSIQD, DataWideD$Duration=="Short")
m2dur = subset(DataWideD$FSIQD, DataWideD$Duration=="Long")

ggplot(DataWideD, aes(FSIQD, fill=Duration, group=Duration)) + 
  geom_vline(xintercept=mean(m1dur), color="#0076C0" ) +  
  geom_vline(xintercept=mean(m2dur), color="#A30134") +
  scale_fill_manual(values = epicolors) + 
  scale_x_continuous(limit = c(-30, 30), breaks=seq(-30,30,by=5)) +
  geom_density(alpha=.70) + 
  geom_vline(xintercept=0, linetype="dashed") +
  geom_point(aes(y = -0.0025, fill=Duration), alpha=0.0, 
           position = position_jitter(height = 0.002), size=2) +
  theme_bw() +
  theme(axis.text.y=element_blank(),axis.ticks=element_blank()) 

```


##
```{r densityfig2, fig.height=5.5}

ggplot(DataWideD, aes(FSIQD, fill=Duration, group=Duration)) + 
  geom_vline(xintercept=mean(m1dur), color="#0076C0" ) +  
  geom_vline(xintercept=mean(m2dur), color="#A30134") +
  scale_fill_manual(values = epicolors) + 
  scale_x_continuous(limit = c(-30, 30), breaks=seq(-30,30,by=5)) +
  geom_density(alpha=.70) + 
  geom_vline(xintercept=0, linetype="dashed") +
  geom_point(aes(y = -0.0025, fill=Duration), alpha=0.8, pch=21,
           position = position_jitter(height = 0.002), size=2) +
  theme_bw() +
  theme(axis.text.y=element_blank(),axis.ticks=element_blank()) 

```


##
```{r parcoordfig, fig.height=5.5}

ggplot(DataLong, aes(Phase, FSIQ, group=ID, label=ID, shape=Duration, colour=Duration)) + 
  geom_line() + xlab("") +
  geom_point(position = position_jitter(w = -0.05)) + 
  ylim(78,147) +
  theme_bw() +
  scale_colour_manual(values = epicolors) +   
  scale_shape_manual(values = c(1, 2)) + 
  geom_segment(aes(x = 1, y = FSlm$coef[1], xend = 2, yend = FSlm$coef[1]+FSlm$coef[2]), 
               alpha=0.01, linetype=1, size=2, colour="#0076C0") +
  geom_segment(aes(x = 1, y = FLlm$coef[1], xend = 2, yend = FLlm$coef[1]+FLlm$coef[2]), 
                 alpha=0.01, linetype=1, size=2, colour="#A30134") 

```


## {.flexbox .vcenter}

<div class="centered">
![](http://lowres.jantoo.com/science-researchers-report-wine-water_into_wine-research_and_development-36236792_low.jpg)
</div>


## The Shrine of *p* < 0.05

"**While we did not detect statistically significant differences** ... <br>   
clinically important improvements for the short duration group occurred in both FSIQ and nonverbal scores; FSIQ and nonverbal scores improved by 13 and 14 points on average, respectively."


## *p* is controversial

<div class="centered">
![](https://pbmo.files.wordpress.com/2013/01/null-hypothesis-by-xkcd.png)
<div>


## Clinicians don't care...

"For the rest of us, 'what is the p-value?' Is this another urine term?" - SCH Doctor (personal communication, 2016)

<br>

<div class="centered">
![](coffee_p.jpg)
</div>


## ... but we <u>must</u>.



## GET FREQY 1

**Confidence Intervals for FSIQ, Short Duration Group Mean**
```{r CIShort}

# FSIQ, Short Group
b1m = boot(ShortFSIQD, function(u,i) mean(u[i]), R = 9999)
ShortFSIQDCI = boot.ci(b1m, type = c("bca"), conf=.90)
# Display results for FSIQ, Short
ShortFSIQDCI

```


## GET FREQY 2

**Confidence Intervals for FSIQ, Long Duration Group Mean**
```{r CILong}

# FSIQ, Long Group
b2m = boot(LongFSIQD, function(u,i) mean(u[i]), R = 9999)
LongFSIQDCI = boot.ci(b2m, type = c("bca"), conf=.90)
# Display results for FSIQ, Long
LongFSIQDCI

```


##

```{r FSIQ_freq}

# frequentist tets
FSIQ.t = t.test(DataWideD$FSIQD~DataWideD$Duration, conf.level = 0.9)
FSIQ.t2 = t.test(DataWideD$FSIQD~DataWideD$Duration, var.equal=T, conf.level = 0.9)
FSIQ.t3 = wilcox_test(DataWideD$FSIQD~DataWideD$Duration, conf.int=T, conf.level = 0.9)
FSIQ.t4 = wilcox_test(DataWideD$FSIQD~DataWideD$Duration, distribution="exact", conf.int=T, conf.level = 0.9)
PermSVL1 = oneway_test(FSIQD~Duration, data=DataWideD, distribution="exact")
FSIQ.lm1 = lm(DataWideD$FSIQD ~ DataWideD$Duration)

```


## The humble *t*-test, default R function

```{r ttest, echo=T}

t.test(DataWideD$FSIQD~DataWideD$Duration, conf.level = 0.9)

```

## The humble *t*-test's *p*-value

<div class="centered"><span style="font-weight:bold; font-style:italic; font-size: 175%; color:red">*p* = `r txtRound(FSIQ.t$p.value,3)`</span></div>  

<br>  

Fisher: "we have weak evidence that our results are different from no effect."  

N-P: "the result is not statistically signficant; either there is no effect *or* our study did not have the power to detect an effect."  


## BUT WAIT!
(No evidence of unequal variances! More POWER!)

```{r ttest2, echo=T}

t.test(DataWideD$FSIQD~DataWideD$Duration, var.equal=TRUE, 
       conf.level = 0.9)

```


## Frequentist *p* values


| Test Type | FSIQ |
| :------------- | -------------- |
| *t*-test, equal variances  | `r txtRound(FSIQ.t2$p.value,3)` | 
| *t*-test, unequal variances  | `r txtRound(FSIQ.t$p.value,3)` | 
| Permutation test  | `r txtRound(pvalue(PermSVL1),3)` | 
| Mann-Whitney-Wilcoxon (asymptotic)  | `r txtRound(pvalue(FSIQ.t3),3)` |
| Mann-Whitney-Wilcoxon (exact) | `r txtRound(pvalue(FSIQ.t4),3)` | 
| Linear model | `r txtRound(summary(FSIQ.lm1)$coefficients[2,4], 3)` |

  
##




## 

